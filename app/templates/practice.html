{% extends "base.html" %}
{% block title %}Investigamer - Practice{% endblock %}
{% block content %}
<div class="container mx-auto py-8">
  <div class="bg-white shadow-md rounded-lg p-6">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Lesson Title outside use-case container -->
    <h1 class="text-3xl font-bold mb-4 text-gray-700">{{ use_case.lesson_title }}</h1>
    <h2 class="text-2xl font-bold mb-4 text-gray-700">Practice</h2>

    {% if is_similar_use_case %}
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert">
      <p class="font-bold">Similar Use Case</p>
      <p>You made a mistake in the previous use case. Here's a similar use case to practice.</p>
    </div>
    {% endif %}

    <div class="use-case-container bg-gray-50 rounded-lg p-4 shadow-inner">
      <div id="progress-bar-container" class="mb-4">
        <div id="progress-bar" class="bg-green-500 text-xs font-medium text-blue-100 text-center p-0.5 leading-none rounded" style="width: 100%">0%</div>
      </div>
      <div id="remaining-use-cases" class="text-sm mb-4 text-right text-gray-600">
        Remaining use cases: <span id="remaining-count">Calculating...</span>
      </div>
      <div id="answer-feedback" class="hidden text-center py-2 px-4 rounded text-white"></div>
      <p id="use-case-description" class="text-lg mb-4 text-gray-700">{{ use_case.description|safe }}</p>
      <form id="questions-form" action="/submit-answer" method="post" enctype="application/json">
        <input type="hidden" name="use_case_id" value="{{ use_case.id }}">
        <div id="questions-container">
          {% for question in use_case.questions %}
          <div class="mb-6">
            <p class="font-bold mb-2 text-gray-700">{{ question.text }}</p>
            {% for option in question.options %}
            <label class="block mb-2">
              <input type="radio" name="answer[{{ question.id }}]" value="{{ option.id }}" class="mr-2">
              {{ option.text }}
            </label>
            {% endfor %}
          </div>
          {% endfor %}
        </div>
        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
          Submit Answer
        </button>
      </form>
      <div class="text-xs text-gray-500 text-right mt-4">
        Lesson ID: {{ use_case.lesson_id }}, UseCase ID: {{ use_case.id }}
      </div>
    </div>
  </div>
</div>
<script src="{{ url_for('static', filename='cfa.js') }}"></script>

<<script>
  document.addEventListener('DOMContentLoaded', function() {
      let totalUseCases = {{ total_use_cases }};
      let completedUseCases = {{ correct_use_cases }};

      const progressBar = document.getElementById('progress-bar');
      const remainingCount = document.getElementById('remaining-count');
      const answerFeedback = document.getElementById('answer-feedback');
      const useCaseContainer = document.querySelector('.use-case-container');

      updateProgressBar();
      updateRemainingUseCases();

      useCaseContainer.addEventListener('submit', async function(event) {
          event.preventDefault();
          if (event.target.tagName === 'FORM') {
              const response = await fetch(event.target.action, {
                  method: event.target.method,
                  body: new FormData(event.target)
              });
              const responseData = await response.json();

              if (responseData.isCorrect) {
                  completedUseCases++;
                  answerFeedback.textContent = 'Correct answer!';
                  answerFeedback.className = 'bg-green-500 text-center py-2 px-4 rounded text-white';
              } else {
                  answerFeedback.textContent = 'Incorrect answer!';
                  answerFeedback.className = 'bg-red-500 text-center py-2 px-4 rounded text-white';
              }
              answerFeedback.classList.remove('hidden');
              setTimeout(() => answerFeedback.classList.add('hidden'), 3000);

              updateProgressBar();
              updateRemainingUseCases();

              if (responseData.nextUseCase) {
                  loadNextUseCase(responseData.nextUseCase);
              } else {
                  useCaseContainer.innerHTML = '<p>All use cases completed!</p>';
              }
          }
      });

      function updateProgressBar() {
          let progressPercentage = (completedUseCases / totalUseCases) * 100;
          progressBar.style.width = `${progressPercentage}%`;
          progressBar.textContent = `${progressPercentage.toFixed(0)}%`;
      }

      function updateRemainingUseCases() {
          let remaining = totalUseCases - completedUseCases;
          remainingCount.textContent = remaining;
      }
  });

  function loadNextUseCase(nextUseCase) {
      // Implement function to load the next use case details
      // This could involve updating the inner HTML of useCaseContainer
  }
</script>
{% endblock %}